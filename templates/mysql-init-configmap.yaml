{{- if .Values.mysql.enabled }}
# MySQL Initialization - Matches StackBill automated setup
# The application will create tables/schema on first run
apiVersion: v1
kind: ConfigMap
metadata:
  name: stackbill-mysql-init
  namespace: {{ .Values.global.namespace }}
  labels:
    app.kubernetes.io/name: stackbill
    app.kubernetes.io/component: mysql-init
data:
  # This script runs after MySQL starts (matches StackBill install scripts)
  01-stackbill-init.sql: |
    -- ============================================
    -- StackBill MySQL Initialization
    -- Based on: docs.stackbill.com/docs/deployment/installing-stackbill-components/installing-mysql
    -- ============================================

    -- Ensure stackbill database exists with proper charset
    CREATE DATABASE IF NOT EXISTS `stackbill`
      CHARACTER SET utf8mb4
      COLLATE utf8mb4_unicode_ci;

    -- Ensure stackbill user has full access
    -- (Bitnami creates user, this ensures all privileges)
    GRANT ALL PRIVILEGES ON `stackbill`.* TO '{{ .Values.mysql.auth.username }}'@'%' WITH GRANT OPTION;
    GRANT ALL PRIVILEGES ON `stackbill`.* TO '{{ .Values.mysql.auth.username }}'@'localhost' WITH GRANT OPTION;

    -- Also grant on any future databases the app might create
    GRANT ALL PRIVILEGES ON *.* TO '{{ .Values.mysql.auth.username }}'@'%' WITH GRANT OPTION;

    FLUSH PRIVILEGES;

    -- Verify setup
    SELECT 'StackBill MySQL initialization completed successfully' AS status;
    SHOW DATABASES LIKE 'stackbill';
    SELECT user, host FROM mysql.user WHERE user = '{{ .Values.mysql.auth.username }}';
{{- end }}

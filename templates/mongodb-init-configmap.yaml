{{- if .Values.mongodb.enabled }}
# MongoDB Initialization - Matches StackBill automated setup
# The application will create collections on first run
apiVersion: v1
kind: ConfigMap
metadata:
  name: stackbill-mongodb-init
  namespace: {{ .Values.global.namespace }}
  labels:
    app.kubernetes.io/name: stackbill
    app.kubernetes.io/component: mongodb-init
data:
  # This script runs after MongoDB starts (matches StackBill install scripts)
  # Based on: docs.stackbill.com/docs/deployment/installing-stackbill-components/installing-mongodb
  init-stackbill.js: |
    // ============================================
    // StackBill MongoDB Initialization
    // ============================================

    print('Starting StackBill MongoDB initialization...');

    // Switch to admin database first
    db = db.getSiblingDB('admin');

    // Ensure stackbill user has proper roles
    try {
      db.grantRolesToUser('{{ .Values.mongodb.auth.username }}', [
        { role: 'readWriteAnyDatabase', db: 'admin' },
        { role: 'dbAdminAnyDatabase', db: 'admin' },
        { role: 'clusterMonitor', db: 'admin' }
      ]);
      print('Roles granted to {{ .Values.mongodb.auth.username }}');
    } catch (e) {
      print('Note: ' + e.message);
    }

    // Switch to stackbill_usage database
    db = db.getSiblingDB('{{ .Values.mongodb.auth.database }}');

    // Create a simple initialization marker collection
    db.createCollection('_init_status');
    db.getCollection('_init_status').insertOne({
      initialized: true,
      timestamp: new Date(),
      version: '{{ .Chart.AppVersion }}'
    });

    print('StackBill MongoDB initialization completed!');
    print('Database: {{ .Values.mongodb.auth.database }}');
    print('User: {{ .Values.mongodb.auth.username }}');

    // List collections
    print('Collections:');
    db.getCollectionNames().forEach(function(c) { print('  - ' + c); });
{{- end }}
